{"version":3,"file":"mapbox-gl-interpolate-heatmap.cjs","sources":["../src/layer.ts"],"sourcesContent":["import earcut from 'earcut';\r\nimport mapboxgl, { CustomLayerInterface } from 'mapbox-gl';\r\n\r\ntype MapboxInterpolateHeatmapLayerOptions = {\r\n  id: string;\r\n  data: { lat: number; lon: number; val: number }[];\r\n  framebufferFactor?: number;\r\n  maxValue?: number;\r\n  minValue?: number;\r\n  opacity?: number;\r\n  p?: number;\r\n  aoi?: { lat: number; lon: number }[];\r\n  valueToColor?: string;\r\n  valueToColor4?: string;\r\n  textureCoverSameAreaAsROI?: boolean;\r\n};\r\n\r\nclass MapboxInterpolateHeatmapLayer implements CustomLayerInterface {\r\n  id: string;\r\n  data: { lat: number; lon: number; val: number }[];\r\n  framebufferFactor: number;\r\n  maxValue: number;\r\n  minValue: number;\r\n  opacity: number;\r\n  p: number;\r\n  aoi?: { lat: number; lon: number }[];\r\n  valueToColor?: string;\r\n  valueToColor4?: string;\r\n  textureCoverSameAreaAsROI: boolean;\r\n  points: number[][] = [];\r\n  // Custom Props\r\n  aPositionComputation?: number;\r\n  aPositionDraw?: number;\r\n  canvas?: HTMLCanvasElement;\r\n  computationFramebuffer: WebGLFramebuffer | null = null;\r\n  computationProgram: WebGLProgram | null = null;\r\n  computationTexture: WebGLTexture | null = null;\r\n  computationVerticesBuffer: WebGLBuffer | null = null;\r\n  drawingVerticesBuffer: WebGLBuffer | null = null;\r\n  drawProgram: WebGLProgram | null = null;\r\n  framebufferHeight?: number;\r\n  framebufferWidth?: number;\r\n  indicesBuffer: WebGLBuffer | null = null;\r\n  indicesNumber: number | null = null;\r\n  renderingMode: '2d' | '3d' = '2d';\r\n  resizeFramebuffer?: () => void;\r\n  type: 'custom' = 'custom' as const;\r\n  uComputationTexture: WebGLUniformLocation | null = null;\r\n  uFramebufferSize: WebGLUniformLocation | null = null;\r\n  uMatrixComputation: WebGLUniformLocation | null = null;\r\n  uMatrixDraw: WebGLUniformLocation | null = null;\r\n  uOpacity: WebGLUniformLocation | null = null;\r\n  uP: WebGLUniformLocation | null = null;\r\n  uScreenSizeDraw: WebGLUniformLocation | null = null;\r\n  uUi: WebGLUniformLocation | null = null;\r\n  uXi: WebGLUniformLocation | null = null;\r\n\r\n  constructor(options: MapboxInterpolateHeatmapLayerOptions) {\r\n    this.id = options.id || '';\r\n    this.data = options.data || [];\r\n    this.aoi = options.aoi || [];\r\n    this.valueToColor =\r\n      options.valueToColor ||\r\n      `\r\n      vec3 valueToColor(float value) {\r\n          return vec3(max((value-0.5)*2.0, 0.0), 1.0 - 2.0*abs(value - 0.5), max((0.5-value)*2.0, 0.0));\r\n      }\r\n  `;\r\n    this.valueToColor4 =\r\n      options.valueToColor4 ||\r\n      `\r\n      vec4 valueToColor4(float value, float defaultOpacity) {\r\n          return vec4(valueToColor(value), defaultOpacity);\r\n      }\r\n  `;\r\n    this.opacity = options.opacity ?? 0.5;\r\n    this.minValue = options.minValue ?? Infinity;\r\n    this.maxValue = options.maxValue ?? -Infinity;\r\n    this.p = options.p ?? 3;\r\n    this.framebufferFactor = options.framebufferFactor ?? 0.3;\r\n    // Having a framebufferFactor < 1 and a texture that don't cover the entire map results in visual artifacts, so we prevent this situation\r\n    this.textureCoverSameAreaAsROI = this.framebufferFactor === 1;\r\n  }\r\n\r\n  onAdd(map: mapboxgl.Map, gl: WebGLRenderingContext): void {\r\n    if (\r\n      !gl.getExtension('OES_texture_float') ||\r\n      !gl.getExtension('WEBGL_color_buffer_float') ||\r\n      !gl.getExtension('EXT_float_blend')\r\n    ) {\r\n      throw 'WebGL extension not supported';\r\n    }\r\n    this.canvas = map.getCanvas();\r\n    const vertexSource = `\r\n              precision highp float;\r\n              attribute vec2 a_Position;\r\n              uniform mat4 u_Matrix;\r\n              void main() {\r\n                  gl_Position = u_Matrix * vec4(a_Position, 0.0, 1.0);\r\n              }\r\n          `;\r\n    const fragmentSource = `\r\n              precision highp float;\r\n              ${this.valueToColor}\r\n              ${this.valueToColor4}\r\n              uniform sampler2D u_ComputationTexture;\r\n              uniform vec2 u_ScreenSize;\r\n              uniform float u_Opacity;\r\n              void main(void) {\r\n                  vec4 data = texture2D(u_ComputationTexture, vec2(gl_FragCoord.x/u_ScreenSize.x, gl_FragCoord.y/u_ScreenSize.y));\r\n                  float u = data.x/data.y;\r\n                  u += u_Opacity*0.00000001; // force WebGL to use u_Opacity. This might not be the case depending on valueToColor4\r\n                  gl_FragColor = valueToColor4(u, u_Opacity);\r\n              }\r\n          `;\r\n    const computationVertexSource = `\r\n              precision highp float;\r\n              uniform mat4 u_Matrix;\r\n              uniform vec2 xi;\r\n              varying vec2 xiNormalized;\r\n              attribute vec2 a_Position;\r\n              void main() {\r\n                  vec4 xiProjected = u_Matrix * vec4(xi, 0.0, 1.0);\r\n                  xiNormalized = vec2(xiProjected.x / xiProjected.w, xiProjected.y / xiProjected.w);\r\n                  gl_Position = u_Matrix * vec4(a_Position, 0.0, 1.0);\r\n              }\r\n          `;\r\n    const computationFragmentSource = `\r\n              precision highp float;\r\n              uniform float ui;\r\n              varying vec2 xiNormalized;\r\n              uniform float p;\r\n              uniform vec2 u_FramebufferSize;\r\n              void main() {\r\n                  vec2 x = vec2(gl_FragCoord.x/u_FramebufferSize.x, gl_FragCoord.y/u_FramebufferSize.y);\r\n                  vec2 xi = vec2((xiNormalized.x + 1.)/2., (xiNormalized.y + 1.)/2.);\r\n                  float dist = distance(x, xi);\r\n                  float wi = 1.0/pow(dist, p);\r\n                  gl_FragColor = vec4(ui*wi, wi, 0.0, 1.0);\r\n              }\r\n          `;\r\n    const computationVertexShader = createVertexShader(\r\n      gl,\r\n      computationVertexSource,\r\n    );\r\n    if (!computationVertexShader)\r\n      throw new Error('error: computation vertex shader not created');\r\n    const computationFragmentShader = createFragmentShader(\r\n      gl,\r\n      computationFragmentSource,\r\n    );\r\n    if (!computationFragmentShader)\r\n      throw new Error('error: computation fragment shader not created');\r\n    this.computationProgram = createProgram(\r\n      gl,\r\n      computationVertexShader,\r\n      computationFragmentShader,\r\n    );\r\n    if (!this.computationProgram)\r\n      throw new Error('error: computation fragment shader not created');\r\n    this.aPositionComputation = gl.getAttribLocation(\r\n      this.computationProgram,\r\n      'a_Position',\r\n    );\r\n    this.uMatrixComputation = gl.getUniformLocation(\r\n      this.computationProgram,\r\n      'u_Matrix',\r\n    );\r\n    this.uUi = gl.getUniformLocation(this.computationProgram, 'ui');\r\n    this.uXi = gl.getUniformLocation(this.computationProgram, 'xi');\r\n    this.uP = gl.getUniformLocation(this.computationProgram, 'p');\r\n    this.uFramebufferSize = gl.getUniformLocation(\r\n      this.computationProgram,\r\n      'u_FramebufferSize',\r\n    );\r\n    if (\r\n      this.aPositionComputation < 0 ||\r\n      !this.uMatrixComputation ||\r\n      !this.uUi ||\r\n      !this.uXi ||\r\n      !this.uP ||\r\n      !this.uFramebufferSize\r\n    ) {\r\n      throw 'WebGL error: Failed to get the storage location of computation variable';\r\n    }\r\n    const drawingVertexShader = createVertexShader(gl, vertexSource);\r\n    if (!drawingVertexShader)\r\n      throw new Error('error: drawing vertex shader not created');\r\n    const drawingFragmentShader = createFragmentShader(gl, fragmentSource);\r\n    if (!drawingFragmentShader)\r\n      throw new Error('error: drawing fragment shader not created');\r\n    this.drawProgram = createProgram(\r\n      gl,\r\n      drawingVertexShader,\r\n      drawingFragmentShader,\r\n    );\r\n    if (!this.drawProgram)\r\n      throw new Error('error: drawing program not created');\r\n    this.aPositionDraw = gl.getAttribLocation(this.drawProgram, 'a_Position');\r\n    this.uMatrixDraw = gl.getUniformLocation(this.drawProgram, 'u_Matrix');\r\n    this.uComputationTexture = gl.getUniformLocation(\r\n      this.drawProgram,\r\n      'u_ComputationTexture',\r\n    );\r\n    this.uScreenSizeDraw = gl.getUniformLocation(\r\n      this.drawProgram,\r\n      'u_ScreenSize',\r\n    );\r\n    this.uOpacity = gl.getUniformLocation(this.drawProgram, 'u_Opacity');\r\n    if (\r\n      this.aPositionDraw < 0 ||\r\n      !this.uMatrixDraw ||\r\n      !this.uComputationTexture ||\r\n      !this.uScreenSizeDraw ||\r\n      !this.uOpacity\r\n    ) {\r\n      throw 'WebGL error: Failed to get the storage location of drawing variable';\r\n    }\r\n    const drawingVertices = [];\r\n    if (this.aoi?.length === 0) {\r\n      drawingVertices.push(-1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0);\r\n    } else {\r\n      this.aoi?.forEach((aoi) => {\r\n        const coordinates = mapboxgl.MercatorCoordinate.fromLngLat(aoi);\r\n        drawingVertices.push(coordinates.x, coordinates.y);\r\n      });\r\n    }\r\n    this.drawingVerticesBuffer = gl.createBuffer();\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.drawingVerticesBuffer);\r\n    gl.bufferData(\r\n      gl.ARRAY_BUFFER,\r\n      new Float32Array(drawingVertices),\r\n      gl.STATIC_DRAW,\r\n    );\r\n    const computationVertices = this.textureCoverSameAreaAsROI\r\n      ? drawingVertices\r\n      : [1.0, 1.0, -1.0, 1.0, 1.0, -1.0, -1.0, -1.0];\r\n    this.computationVerticesBuffer = gl.createBuffer();\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.computationVerticesBuffer);\r\n    gl.bufferData(\r\n      gl.ARRAY_BUFFER,\r\n      new Float32Array(computationVertices),\r\n      gl.STATIC_DRAW,\r\n    );\r\n    const indices = earcut(drawingVertices);\r\n    this.indicesBuffer = gl.createBuffer();\r\n    if (!this.indicesBuffer)\r\n      throw new Error('error: indices buffer not created');\r\n    this.indicesNumber = indices.length;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indicesBuffer);\r\n    gl.bufferData(\r\n      gl.ELEMENT_ARRAY_BUFFER,\r\n      new Uint8Array(indices),\r\n      gl.STATIC_DRAW,\r\n    );\r\n    this.framebufferWidth = Math.ceil(\r\n      this.canvas.width * this.framebufferFactor,\r\n    );\r\n    this.framebufferHeight = Math.ceil(\r\n      this.canvas.height * this.framebufferFactor,\r\n    );\r\n    this.computationTexture = gl.createTexture();\r\n    gl.bindTexture(gl.TEXTURE_2D, this.computationTexture);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n    gl.texImage2D(\r\n      gl.TEXTURE_2D,\r\n      0,\r\n      gl.RGBA,\r\n      this.framebufferWidth,\r\n      this.framebufferHeight,\r\n      0,\r\n      gl.RGBA,\r\n      gl.FLOAT,\r\n      null,\r\n    );\r\n    this.computationFramebuffer = gl.createFramebuffer();\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this.computationFramebuffer);\r\n    gl.framebufferTexture2D(\r\n      gl.FRAMEBUFFER,\r\n      gl.COLOR_ATTACHMENT0,\r\n      gl.TEXTURE_2D,\r\n      this.computationTexture,\r\n      0,\r\n    );\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    this.points = [];\r\n    let minValue = Infinity;\r\n    let maxValue = -Infinity;\r\n    this.data.forEach((rawPoint) => {\r\n      const mercatorCoordinates =\r\n        mapboxgl.MercatorCoordinate.fromLngLat(rawPoint);\r\n      this.points.push([\r\n        mercatorCoordinates.x,\r\n        mercatorCoordinates.y,\r\n        rawPoint.val,\r\n      ]);\r\n      if (rawPoint.val < minValue) {\r\n        minValue = rawPoint.val;\r\n      }\r\n      if (rawPoint.val > maxValue) {\r\n        maxValue = rawPoint.val;\r\n      }\r\n    });\r\n    minValue = minValue < this.minValue ? minValue : this.minValue;\r\n    maxValue = maxValue > this.maxValue ? maxValue : this.maxValue;\r\n    this.points.forEach((point) => {\r\n      point[2] = (point[2] - minValue) / (maxValue - minValue);\r\n    });\r\n    this.resizeFramebuffer = () => {\r\n      if (!this.canvas || !this.canvas.width || !this.canvas.height)\r\n        throw new Error('error: required canvas `width` & `height`');\r\n      this.framebufferWidth = Math.ceil(\r\n        this.canvas.width * this.framebufferFactor,\r\n      );\r\n      this.framebufferHeight = Math.ceil(\r\n        this.canvas.height * this.framebufferFactor,\r\n      );\r\n      gl.bindTexture(gl.TEXTURE_2D, this.computationTexture);\r\n      gl.texImage2D(\r\n        gl.TEXTURE_2D,\r\n        0,\r\n        gl.RGBA,\r\n        this.framebufferWidth,\r\n        this.framebufferHeight,\r\n        0,\r\n        gl.RGBA,\r\n        gl.FLOAT,\r\n        null,\r\n      );\r\n    };\r\n    map.on('resize', this.resizeFramebuffer);\r\n  }\r\n  onRemove(map: mapboxgl.Map, gl: WebGLRenderingContext): void {\r\n    if (!this.resizeFramebuffer)\r\n      throw new Error('error: required resize frame buffer callback');\r\n    map.off('resize', this.resizeFramebuffer);\r\n    gl.deleteTexture(this.computationTexture);\r\n    gl.deleteBuffer(this.drawingVerticesBuffer);\r\n    gl.deleteBuffer(this.computationVerticesBuffer);\r\n    gl.deleteBuffer(this.indicesBuffer);\r\n    gl.deleteFramebuffer(this.computationFramebuffer);\r\n  }\r\n  prerender(gl: WebGLRenderingContext, matrix: number[]): void {\r\n    if (\r\n      !this.framebufferWidth ||\r\n      !this.framebufferHeight ||\r\n      this.aPositionComputation === undefined ||\r\n      !this.indicesNumber ||\r\n      !this.canvas ||\r\n      !this.canvas.width ||\r\n      !this.canvas.height\r\n    ) {\r\n      throw new Error('error: missing options for prerendering');\r\n    }\r\n    gl.disable(gl.DEPTH_TEST);\r\n    gl.enable(gl.BLEND);\r\n    gl.blendEquation(gl.FUNC_ADD);\r\n    gl.blendFunc(gl.ONE, gl.ONE);\r\n    gl.clearColor(0.0, 0.0, 0.0, 1.0);\r\n    gl.useProgram(this.computationProgram);\r\n    gl.uniformMatrix4fv(this.uMatrixComputation, false, matrix);\r\n    gl.uniform1f(this.uP, this.p);\r\n    gl.uniform2f(\r\n      this.uFramebufferSize,\r\n      this.framebufferWidth,\r\n      this.framebufferHeight,\r\n    );\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this.computationFramebuffer);\r\n    gl.viewport(0, 0, this.framebufferWidth, this.framebufferHeight);\r\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indicesBuffer);\r\n    for (let i = 0; i < this.points.length; i += 1) {\r\n      const point = this.points.at(i);\r\n      if (!point) throw new Error(`error: point not found at index: ${i}`);\r\n      gl.uniform1f(this.uUi, point[2]);\r\n      gl.uniform2f(this.uXi, point[0], point[1]);\r\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.computationVerticesBuffer);\r\n      gl.enableVertexAttribArray(this.aPositionComputation);\r\n      gl.vertexAttribPointer(\r\n        this.aPositionComputation,\r\n        2,\r\n        gl.FLOAT,\r\n        false,\r\n        0,\r\n        0,\r\n      );\r\n      if (this.textureCoverSameAreaAsROI) {\r\n        gl.drawElements(gl.TRIANGLES, this.indicesNumber, gl.UNSIGNED_BYTE, 0);\r\n      } else {\r\n        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n      }\r\n    }\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    gl.viewport(0, 0, this.canvas.width, this.canvas.height);\r\n  }\r\n  render(gl: WebGLRenderingContext, matrix: number[]): void {\r\n    if (\r\n      this.aPositionDraw === undefined ||\r\n      !this.canvas ||\r\n      !this.canvas.width ||\r\n      !this.canvas.height ||\r\n      !this.indicesNumber\r\n    ) {\r\n      throw new Error('error: missing options for rendering');\r\n    }\r\n    gl.useProgram(this.drawProgram);\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.drawingVerticesBuffer);\r\n    gl.enableVertexAttribArray(this.aPositionDraw);\r\n    gl.vertexAttribPointer(this.aPositionDraw, 2, gl.FLOAT, false, 0, 0);\r\n    gl.uniformMatrix4fv(this.uMatrixDraw, false, matrix);\r\n    gl.activeTexture(gl.TEXTURE0);\r\n    gl.bindTexture(gl.TEXTURE_2D, this.computationTexture);\r\n    gl.uniform1i(this.uComputationTexture, 0);\r\n    gl.uniform2f(this.uScreenSizeDraw, this.canvas.width, this.canvas.height);\r\n    gl.uniform1f(this.uOpacity, this.opacity);\r\n    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indicesBuffer);\r\n    gl.drawElements(gl.TRIANGLES, this.indicesNumber, gl.UNSIGNED_BYTE, 0);\r\n  }\r\n}\r\n/**\r\n * @param {WebGLRenderingContext} gl - WebGL context\r\n * @param {string } source - source of the shader\r\n * @returns {WebGLShader | undefined} - compiled shader\r\n */\r\nfunction createVertexShader(\r\n  gl: WebGLRenderingContext,\r\n  source: string,\r\n): WebGLShader | undefined {\r\n  const vertexShader = gl.createShader(gl.VERTEX_SHADER);\r\n  if (vertexShader) return compileShader(gl, vertexShader, source);\r\n}\r\n/**\r\n * @param {WebGLRenderingContext} gl - WebGL context\r\n * @param {string } source - source of the shader\r\n * @returns {WebGLShader | undefined} - compiled shader\r\n */\r\nfunction createFragmentShader(\r\n  gl: WebGLRenderingContext,\r\n  source: string,\r\n): WebGLShader | undefined {\r\n  const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);\r\n  if (fragmentShader) return compileShader(gl, fragmentShader, source);\r\n}\r\n/**\r\n * @param {WebGLRenderingContext} gl - WebGL context\r\n * @param {WebGLShader} shader - shader to compile\r\n * @param {string} source - source of the shader\r\n * @returns {WebGLShader | undefined} - compiled shader\r\n */\r\nfunction compileShader(\r\n  gl: WebGLRenderingContext,\r\n  shader: WebGLShader,\r\n  source: string,\r\n): WebGLShader | undefined {\r\n  gl.shaderSource(shader, source);\r\n  gl.compileShader(shader);\r\n  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\r\n    throw gl.getShaderInfoLog(shader);\r\n  }\r\n  return shader;\r\n}\r\n\r\n/**\r\n * @param {WebGLRenderingContext} gl - WebGL context\r\n * @param {WebGLShader} vertexShader - vertext shader\r\n * @param {WebGLShader} fragmentShader - fragment shader\r\n * @returns {WebGLProgram | null} - compiled program\r\n */\r\nfunction createProgram(\r\n  gl: WebGLRenderingContext,\r\n  vertexShader: WebGLShader,\r\n  fragmentShader: WebGLShader,\r\n): WebGLProgram | null {\r\n  const program = gl.createProgram();\r\n  if (program) {\r\n    gl.attachShader(program, vertexShader);\r\n    gl.attachShader(program, fragmentShader);\r\n    gl.linkProgram(program);\r\n    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\r\n      throw gl.getProgramInfoLog(program);\r\n    }\r\n  }\r\n  return program;\r\n}\r\nexport { MapboxInterpolateHeatmapLayer };\r\n\r\n"],"names":["MapboxInterpolateHeatmapLayer","options","map","gl","vertexSource","fragmentSource","computationVertexSource","computationFragmentSource","computationVertexShader","createVertexShader","computationFragmentShader","createFragmentShader","createProgram","drawingVertexShader","drawingFragmentShader","drawingVertices","aoi","coordinates","mapboxgl","computationVertices","indices","earcut","minValue","maxValue","rawPoint","mercatorCoordinates","point","matrix","source","vertexShader","compileShader","fragmentShader","shader","program"],"mappings":"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"}